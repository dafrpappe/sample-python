pipeline {
  agent { 
    dockerfile {
      args '-u root'
    } 
  } 
  stages {
    stage('Setup parameters') {
        steps {
            script { 
                properties([
                    parameters([
                       password(name: 'git-token', description: 'Encryption key')
                    ])
                ])
            }
        }
    }     
    stage('Publish on github'){
        steps{
            sh '''
               echo ${git-token}
               rm -rf sample-python
               ls -l
               git clone https://github.com/dafrpappe/sample-python.git


               '''


        }
    }
    stage('Build artifact'){
      steps {
        sh '''
           echo "Publishing on Github..."

           cd sample-python
           token="${git-token}"
           
           # Get the last tag name
           tag=$(git describe --tags)
           
           # Get the full message associated with this tag
           message="$(git for-each-ref refs/tags/$tag --format='%(contents)')"
           echo "${message}"
           
           # Upload the artifact
           curl -XPOST -H "Authorization:token $token" -H "Content-Type:application/octet-stream" --data-binary @artifact.zip https://uploads.github.com/repos/dafrpappe/sample-python/releases/$id/assets?name=artifact.zip

           echo "DONE"
           

        '''
      }    
    }
    stage('Build') {
      steps {
        // Clean before build
        sh '''
           echo "Building artifact ....."

        '''

      }
    }    
  }
}